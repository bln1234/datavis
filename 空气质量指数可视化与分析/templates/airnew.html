<!DOCTYPE html>
<html>
<head>
    <title>站点某时段空气质量</title>
    <script src="d3.v3.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/echarts@5.3.0/dist/echarts.min.js"></script>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 20px;
            overflow-y: auto;
        }
        #lineChart {
            width: 100%;
            height: 300px;
        }
        #pieChart {
            width: 100%;
            height: 300px;
            margin-top: 20px;
        }
        #timePieChart {
            width: 100%;
            height: 300px;
            margin-top: 20px;
        }
    </style>
</head>
<body>
    <div>
        <label for="text1">输入监测站点号：</label>
        <input type="text" id="text1">
        <br>
        <label for="select2">选择污染物：</label>
        <select id="select2">
            <option value="AQI">AQI</option>
            <option value="PM2.5">PM2.5</option>
            <option value="PM10">PM10</option>
            <option value="SO2">SO2</option>
            <option value="NO2">NO2</option>
            <option value="O3">O3</option>
            <option value="CO">CO</option>
        </select>
        <br>
        <label for="selectTime">选择时间：</label>
        <select id="selectTime">
            <!-- 生成0到23的选项 -->
            <script>
                for (let i = 0; i < 24; i++) {
                    document.write(`<option value="${i}">${i}:00</option>`);
                }
            </script>
        </select>
    </div>

    <div id="lineChart"></div>
    <div id="pieChart"></div>
    <div id="timePieChart"></div>

    <script>
        var lineChart = echarts.init(document.getElementById('lineChart'));
        var pieChart = echarts.init(document.getElementById('pieChart'));
        var timePieChart = echarts.init(document.getElementById('timePieChart'));

        function updateChart() {
            var site = document.getElementById('text1').value;
            var detection = document.getElementById('select2').value;
            var selectedTime = parseInt(document.getElementById('selectTime').value);
            
            d3.json("../china_sites_20240601.json", function(air_quality) {
                var air = [];
                var pollutants = {AQI: 0, PM25: 0, PM10: 0, SO2: 0, NO2: 0, O3: 0, CO: 0};
                var timePollutants = {AQI: 0, PM25: 0, PM10: 0, SO2: 0, NO2: 0, O3: 0, CO: 0};
                
                for (var i = 0; i < 24; i++) {
                    if (air_quality[i * 15 + 1][site]) {
                        pollutants.PM25 += parseFloat(air_quality[i * 15 + 1][site]);
                        if (i == selectedTime) timePollutants.PM25 = parseFloat(air_quality[i * 15 + 1][site]);
                    }
                    if (air_quality[i * 15 + 3][site]) {
                        pollutants.PM10 += parseFloat(air_quality[i * 15 + 3][site]);
                        if (i == selectedTime) timePollutants.PM10 = parseFloat(air_quality[i * 15 + 3][site]);
                    }
                    if (air_quality[i * 15 + 5][site]) {
                        pollutants.SO2 += parseFloat(air_quality[i * 15 + 5][site]);
                        if (i == selectedTime) timePollutants.SO2 = parseFloat(air_quality[i * 15 + 5][site]);
                    }
                    if (air_quality[i * 15 + 7][site]) {
                        pollutants.NO2 += parseFloat(air_quality[i * 15 + 7][site]);
                        if (i == selectedTime) timePollutants.NO2 = parseFloat(air_quality[i * 15 + 7][site]);
                    }
                    if (air_quality[i * 15 + 9][site]) {
                        pollutants.O3 += parseFloat(air_quality[i * 15 + 9][site]);
                        if (i == selectedTime) timePollutants.O3 = parseFloat(air_quality[i * 15 + 9][site]);
                    }
                    if (air_quality[i * 15 + 13][site]) {
                        pollutants.CO += parseFloat(air_quality[i * 15 + 13][site]);
                        if (i == selectedTime) timePollutants.CO = parseFloat(air_quality[i * 15 + 13][site]);
                    }
                }

                // 归一化
                var totalPollutants = pollutants.AQI + pollutants.PM25 + pollutants.PM10 + pollutants.SO2 + pollutants.NO2 + pollutants.O3 + pollutants.CO;
                if (totalPollutants > 0) {
                    for (var key in pollutants) {
                        pollutants[key] = pollutants[key] / totalPollutants * 100;
                    }
                }

                var totalTimePollutants = timePollutants.AQI + timePollutants.PM25 + timePollutants.PM10 + timePollutants.SO2 + timePollutants.NO2 + timePollutants.O3 + timePollutants.CO;
                if (totalTimePollutants > 0) {
                    for (var key in timePollutants) {
                        timePollutants[key] = timePollutants[key] / totalTimePollutants * 100;
                    }
                }

                if (detection == 'AQI' ) {
                    for (var i = 0; i < 24; i++) {
                        if (air_quality[i * 15 + 0][site]) {
                            air[i] = parseFloat(air_quality[i * 15 + 0][site]);
                        } else {
                            air[i] = 0;
                        }
                    }
                } else if (detection == 'PM2.5' ) {
                    for (var i = 0; i < 24; i++) {
                        if (air_quality[i * 15 + 1][site]) {
                            air[i] = parseFloat(air_quality[i * 15 + 1][site]);
                        } else {
                            air[i] = 0;
                        }
                    }
                } else if (detection == 'PM10') {
                    for (var i = 0; i < 24; i++) {
                        if (air_quality[i * 15 + 3][site]) {
                            air[i] = parseFloat(air_quality[i * 15 + 3][site]);
                        } else {
                            air[i] = 0;
                        }
                    }
                } else if (detection == 'SO2') {
                    for (var i = 0; i < 24; i++) {
                        if (air_quality[i * 15 + 5][site]) {
                            air[i] = parseFloat(air_quality[i * 15 + 5][site]);
                        } else {
                            air[i] = 0;
                        }
                    }
                } else if (detection == 'NO2') {
                    for (var i = 0; i < 24; i++) {
                        if (air_quality[i * 15 + 7][site]) {
                            air[i] = parseFloat(air_quality[i * 15 + 7][site]);
                        } else {
                            air[i] = 0;
                        }
                    }
                } else if (detection == 'O3') {
                    for (var i = 0; i < 24; i++) {
                        if (air_quality[i * 15 + 9][site]) {
                            air[i] = parseFloat(air_quality[i * 15 + 9][site]);
                        } else {
                            air[i] = 0;
                        }
                    }
                } else if (detection == 'CO') {
                    for (var i = 0; i < 24; i++) {
                        if (air_quality[i * 15 + 13][site]) {
                            air[i] = parseFloat(air_quality[i * 15 + 13][site]);
                        } else {
                            air[i] = 0;
                        }
                    }
                } else {
                    for (var i = 0; i < 24; i++) {
                        air[i] = 0;
                    }
                }
                console.log(air);
                d3.json("../站点列表.json", function(data) {
                    var len = data.length;
                    var city = "";
                    for (var j = 0; j < len; j++) {
                        if (site == data[j].Column1) {
                            city = city + data[j].Column3 + "的" + data[j].Column2 + "监测点" + "的" + detection + "指标：";
                            break;
                        }
                    }
                    if (city == "") city = "监测站点输入不对";
                    var lineOption = {
                        title: {
                            text: city
                        },
                        tooltip: {
                            trigger: 'axis'
                        },
                        xAxis: {
                            type: 'category',
                            data: [0, 1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12, 13, 14, 15, 16, 17, 18, 19, 20, 21, 22, 23]
                        },
                        yAxis: {
                            type: 'value'
                        },
                        series: [{
                            data: air,
                            type: 'line'
                        }]
                    };
                    lineChart.setOption(lineOption);

                    var pieOption = {
                        title: {
                            text: '污染物比例',
                            left: 'center'
                        },
                        tooltip: {
                            trigger: 'item'
                        },
                        series: [{
                            name: '污染物',
                            type: 'pie',
                            radius: '50%',
                            data: [
                                { value: pollutants.PM25, name: 'PM2.5' },
                                { value: pollutants.PM10, name: 'PM10' },
                                { value: pollutants.SO2, name: 'SO2' },
                                { value: pollutants.NO2, name: 'NO2' },
                                { value: pollutants.O3, name: 'O3' },
                                { value: pollutants.CO, name: 'CO' }
                            ],
                            emphasis: {
                                itemStyle: {
                                    shadowBlur: 10,
                                    shadowOffsetX: 0,
                                    shadowColor: 'rgba(0, 0, 0, 0.5)'
                                }
                            }
                        }]
                    };
                    pieChart.setOption(pieOption);

                    var timePieOption = {
                        title: {
                            text: '时间段污染物比例',
                            left: 'center'
                        },
                        tooltip: {
                            trigger: 'item'
                        },
                        series: [{
                            name: '污染物',
                            type: 'pie',
                            radius: '50%',
                            data: [
                                { value: timePollutants.PM25, name: 'PM2.5' },
                                { value: timePollutants.PM10, name: 'PM10' },
                                { value: timePollutants.SO2, name: 'SO2' },
                                { value: timePollutants.NO2, name: 'NO2' },
                                { value: timePollutants.O3, name: 'O3' },
                                { value: timePollutants.CO, name: 'CO' }
                            ],
                            emphasis: {
                                itemStyle: {
                                    shadowBlur: 10,
                                    shadowOffsetX: 0,
                                    shadowColor: 'rgba(0, 0, 0, 0.5)'
                                }
                            }
                        }]
                    };
                    timePieChart.setOption(timePieOption);
                });
            });
        }

        function getQueryParam(param) {
            const urlParams = new URLSearchParams(window.location.search);
            return urlParams.get(param);
        }

        const initialSite = getQueryParam('site');
        if (initialSite) {
            document.getElementById('text1').value = initialSite;
        }
        document.getElementById('text1').addEventListener('input', updateChart);
        document.getElementById('select2').addEventListener('change', updateChart);
        document.getElementById('selectTime').addEventListener('change', updateChart);
        updateChart();
    </script>
</body>
</html>
